# Отчет по лабораторной работе №3
## Операционные системы

### Студент: Ляшенко Никита Андреевич
### Группа: P3309
### Преподаватель: Гиниятуллин Арслан
### Вариант: 
ioctl: vmstat
Разработать модуль ядра, реализующий функционал утилиты vmstat.

## Задание
Разработать комплекс программ на пользовательском уровне и уровне ярда, который собирает информацию на стороне ядра и передает информацию на уровень пользователя, и выводит ее в удобном для чтения человеком виде. Программа на уровне пользователя получает на вход аргумент(ы) командной строки (не адрес!), позволяющие идентифицировать из системных таблиц необходимый путь до целевой структуры, осуществляет передачу на уровень ядра, получает информацию из данной структуры и распечатывает структуру в стандартный вывод. Загружаемый модуль ядра принимает запрос через указанный в задании интерфейс, определяет путь до целевой структуры по переданному запросу и возвращает результат на уровень пользователя.

Интерфейс передачи между программой пользователя и ядром и целевая структура задается преподавателем. Интерфейс передачи может быть один из следующих:

1. syscall - интерфейс системных вызовов.
2. ioctl - передача параметров через управляющий вызов к файлу/устройству.
3. procfs - файловая система /proc, передача параметров через запись в файл.
4. debugfs - отладочная файловая система /sys/kernel/debug, передача параметров через запись в файл.

Целевая структура может быть задана двумя способами:

1. Именем структуры в заголовочных файлах Linux
2. Файлом в каталоге /proc. В этом случае необходимо определить целевую структуру по пути файла в /proc и выводимым данным.

## Реализация

### Основные файлы
- **vmstat_kernel.c** - модуль ядра
- **vmstat_user.c** - пользовательская программа
- **Makefile** - файл сборки

### Структура данных
```c
struct vmstat_data {
    // Количество процессов в состоянии TASK_RUNNING
    unsigned long procs_running;
    // Количество процессов в состоянии TASK_UNINTERRUPTIBLE
    unsigned long procs_blocked;
    
    // Количество свободных страниц свопа (через get_nr_swap_pages)
    unsigned long mem_swpd;
    // Количество свободной памяти в КБ (из si.freeram)
    unsigned long mem_free;
    // Размер буферов в КБ (из si.bufferram)
    unsigned long mem_buff;
    // Размер кэша файловой системы в КБ (из NR_FILE_PAGES)
    unsigned long mem_cache;
    
    // Количество страниц, загруженных из свопа (PSWPIN)
    unsigned long swap_si;
    // Количество страниц, выгруженных в своп (PSWPOUT)
    unsigned long swap_so;
    
    // Количество страниц, прочитанных с диска (PGPGIN)
    unsigned long io_bi;
    // Количество страниц, записанных на диск (PGPGOUT)
    unsigned long io_bo;
    
    // Общее количество прерываний по всем CPU (сумма kstat_cpu_irqs_sum)
    unsigned long system_in;
    // Общее количество переключений контекста (сумма ctxt_switches)
    unsigned long system_cs;
    
    // Процент времени CPU в пользовательском режиме (user + nice)
    unsigned long cpu_us;
    // Процент времени CPU в системном режиме (system + irq + softirq)
    unsigned long cpu_sy;
    // Процент времени CPU в режиме простоя (idle)
    unsigned long cpu_id;
    // Процент времени CPU в ожидании IO (iowait)
    unsigned long cpu_wa;
    // Процент времени CPU, украденного гипервизором (steal)
    unsigned long cpu_st;
};
```

### Ключевые функции модуля
1. **vmstat_init** - инициализация модуля и создание устройства
2. **vmstat_exit** - очистка ресурсов при выгрузке модуля
3. **vmstat_ioctl** - обработка запросов от пользовательских программ

### Основные этапы сборки
1. Загрузка модуля:
```bash
sudo insmod vmstat_kernel.ko
```

2. Создание устройства:
```bash
cat /proc/devices | grep vmstat
sudo mknod /dev/vmstat_dev c XXX 0
sudo chmod 666 /dev/vmstat_dev
```

3. Запуск пользовательской программы:
```bash
./vmstat_user
```

4. Удаление устройства и модуля:
```bash
sudo rm /dev/vmstat_dev
sudo rmmod vmstat_kernel
```

### Особенности реализации
- Использование RCU для безопасного доступа к списку процессов
- Нормализация значений swap и IO операций
- Расчет статистики CPU с учетом всех ядер
- Использование per_cpu структур для сбора статистики

### Пример вывода
```
user@vbox:~/Desktop/OS-lab3/src$ vmstat
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0 727236  71408  82352 447188    8   76   184   203  445 1073  6  7 87  0  0
user@vbox:~/Desktop/OS-lab3/src$ ./vmstat_user
 -----------memory---------- ---swap-- -----io---- --system-- -----cpu------
swpd   free   buff  cache   si   so    bi    bo   in   cs  us sy id wa st
 66506 193644  88516 542440 190711 8368 161095   626 347202    0  4  5 89  0  0
```

## Тестирование
Сравнение вывода стандартной утилиты vmstat и разработанного модуля показало схожие результаты с небольшими отклонениями, что объясняется различными методами сбора статистики и временем усреднения показателей.

## Выводы
В ходе выполнения лабораторной работы был разработан модуль ядра Linux, предоставляющий информацию о состоянии системы через символьное устройство. Модуль успешно собирает и предоставляет статистику о процессах, памяти, swap, IO операциях и использовании CPU.
