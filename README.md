# Отчет по лабораторной работе №3
## Операционные системы

### Студент: Ляшенко Никита Андреевич
### Группа: P3309
### Преподаватель: Гиниятуллин Арслан
### Вариант: 
ioctl: vmstat
Разработать модуль ядра, реализующий функционал утилиты vmstat.

## Задание
Разработать комплекс программ на пользовательском уровне и уровне ярда, который собирает информацию на стороне ядра и передает информацию на уровень пользователя, и выводит ее в удобном для чтения человеком виде. Программа на уровне пользователя получает на вход аргумент(ы) командной строки (не адрес!), позволяющие идентифицировать из системных таблиц необходимый путь до целевой структуры, осуществляет передачу на уровень ядра, получает информацию из данной структуры и распечатывает структуру в стандартный вывод. Загружаемый модуль ядра принимает запрос через указанный в задании интерфейс, определяет путь до целевой структуры по переданному запросу и возвращает результат на уровень пользователя.

Интерфейс передачи между программой пользователя и ядром и целевая структура задается преподавателем. Интерфейс передачи может быть один из следующих:

1. syscall - интерфейс системных вызовов.
2. ioctl - передача параметров через управляющий вызов к файлу/устройству.
3. procfs - файловая система /proc, передача параметров через запись в файл.
4. debugfs - отладочная файловая система /sys/kernel/debug, передача параметров через запись в файл.

Целевая структура может быть задана двумя способами:

1. Именем структуры в заголовочных файлах Linux
2. Файлом в каталоге /proc. В этом случае необходимо определить целевую структуру по пути файла в /proc и выводимым данным.

## Реализация

### Основные файлы
- **vmstat_kernel.c** - модуль ядра
- **vmstat_user.c** - пользовательская программа
- **Makefile** - файл сборки

### Структура данных
```c
struct vmstat_data {
    unsigned long procs_running;    // Количество запущенных процессов
    unsigned long procs_blocked;    // Количество заблокированных процессов
    unsigned long mem_swpd;         // Используемая память подкачки
    unsigned long mem_free;         // Свободная память
    unsigned long mem_buff;         // Буферизованная память
    unsigned long mem_cache;        // Кэшированная память
    unsigned long swap_si;          // Swap in
    unsigned long swap_so;          // Swap out
    unsigned long io_bi;            // Блоки, прочитанные с устройства
    unsigned long io_bo;            // Блоки, записанные на устройство
    unsigned long system_in;        // Прерывания в секунду
    unsigned long system_cs;        // Переключения контекста в секунду
    unsigned long cpu_us;          // Время CPU в пользовательском режиме
    unsigned long cpu_sy;          // Время CPU в системном режиме
    unsigned long cpu_id;          // Время CPU в простое
    unsigned long cpu_wa;          // Время ожидания IO
    unsigned long cpu_st;          // Время гипервизора
};
```

### Ключевые функции модуля
1. **vmstat_init** - инициализация модуля и создание устройства
2. **vmstat_exit** - очистка ресурсов при выгрузке модуля
3. **vmstat_ioctl** - обработка запросов от пользовательских программ

### Основные этапы сборки
1. Загрузка модуля:
```bash
sudo insmod vmstat_kernel.ko
```

2. Создание устройства:
```bash
cat /proc/devices | grep vmstat
sudo mknod /dev/vmstat_dev c XXX 0
sudo chmod 666 /dev/vmstat_dev
```

3. Запуск пользовательской программы:
```bash
./vmstat_user
```

4. Удаление устройства и модуля:
```bash
sudo rm /dev/vmstat_dev
sudo rmmod vmstat_kernel
```

### Особенности реализации
- Использование RCU для безопасного доступа к списку процессов
- Нормализация значений swap и IO операций
- Расчет статистики CPU с учетом всех ядер
- Использование per_cpu структур для сбора статистики

### Пример вывода
```
user@vbox:~/Desktop/OS-lab3/src$ vmstat 
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 194184  36816 728272    0    0   958   207  451  510  9 17 73  0  0
user@vbox:~/Desktop/OS-lab3/src$ ./vmstat_user 
procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs  us sy id wa st
 2  0      0 194184  36824 723904    0    0  1285   277   74    0  8 15 75  0  0
```

## Тестирование
Сравнение вывода стандартной утилиты vmstat и разработанного модуля показало схожие результаты с небольшими отклонениями, что объясняется различными методами сбора статистики и временем усреднения показателей.

## Выводы
В ходе выполнения лабораторной работы был разработан модуль ядра Linux, предоставляющий информацию о состоянии системы через символьное устройство. Модуль успешно собирает и предоставляет статистику о процессах, памяти, swap, IO операциях и использовании CPU.
